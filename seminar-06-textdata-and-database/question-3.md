# Основные функции и возможности СУБД

### Что такое СУБД и зачем она нужна
**СУБД** — это программная система, которая хранит данные и предоставляет средства для их доступа, изменения, защиты и восстановления. Она превращает сырые файлы в удобный, управляемый ресурс: управляет структурой данных, обеспечивает корректность действий (транзакции), защищает доступ и помогает масштабировать приложение по мере роста нагрузки.

Простая, наглядная аналогия, которая мне помогает запомнить:
- Excel файл с данными = как просто папка с бумагами;
- СУБД = как умный архив с системой каталогов и архивариусом.

То есть СУБД — это как умный организатор для данных. Вместо того чтобы хранить всё в куче файлов (как в папках на компьютере), мы используем специальную программу, которая умеет:
- хранить данные структурированно;
- быстро находить нужную информацию;
- защищать данные от повреждений;
- разрешать доступ разным людям к разным данным.

---

### 1. Базовые возможности СУБД
- Хранение данных на диске; управление форматом и физическим размещением.  
- Интерфейсы для операций CRUD (Create, Read, Update, Delete).  
- Язык запросов (в реляционных СУБД — SQL) для выборки и трансформации данных.  
- Индексация для ускорения поиска.  
- Механизмы транзакций и гарантий ACID.  
- Инструменты целостности данных: PK, FK, UNIQUE, CHECK и т. п.  
- Безопасность: аутентификация, роли, аудиты, шифрование.  
- Отказоустойчивость: репликация, резервные копии, WAL, failover.  
- Масштабирование: шардирование, реплики, кэширование.  
- Мониторинг и администрирование: логи, метрики, алёрты.  
- Расширяемость: хранимые процедуры, расширения (PostGIS и пр.), CDC.

---

### 2. Физическое хранение — что важно понимать
- Данные лежат в файлах, разбитыми на страницы (blocks/pages).  
- СУБД читает/пишет страницы целиком, поэтому проектирование схемы и индексов должно учитывать I/O.  
- Буферный пул (кэш в RAM) сильно влияет на производительность: корректная настройка — базовый шаг оптимизации.  
- WAL (write‑ahead log) — сначала записываем в журнал, затем применяем к данным; это гарантирует атомарность и помогает восстановлению.

Практическая мысль: на маленьком VPS недостаток RAM — частая причина медленной работы БД.

---

### 3. Индексы — смысл и компромиссы
- Индекс = дополнительная структура (обычно дерево или LSM) для быстрого поиска.  
- B‑Tree — универсальный выбор для большинства запросов (диапазоны, сортировка).  
- Hash — быстрый для точных матчей; не подходит для диапазонов.  
- LSM (лог‑структура) — хороша при очень частых записях (write‑heavy).  
- Специализированные типы: GiST/GIN (PostgreSQL) для полнотекста, JSONB, массивов; BRIN для больших физически упорядоченных таблиц.  
- Индексы ускоряют чтение, но замедляют запись и занимают место — ставьте осознанно.

Совет: начни с индекса по полям, используемым в WHERE/JOIN/ORDER BY, и замеряй эффект.

---

### 4. Как СУБД выполняет запрос
1. Парсинг SQL → синтаксическая проверка.  
2. Семантика → проверка существования таблиц/полей и прав.  
3. Построение логического плана (реляционная алгебра).  
4. Оптимизация: cost‑based optimizer выбирает порядок join'ов, индексы, методы сортировки.  
5. Исполнение плана: чтение страниц, применение join'ов, агрегирование, выдача результата.  

Инструменты: `EXPLAIN` / `EXPLAIN ANALYZE` показывают план и реальные затраты.

---

### 5. Транзакции и ACID
- Atomicity: или всё успешно, или откат.  
- Consistency: правила схемы сохраняются.  
- Isolation: параллельные транзакции не мешают друг другу (виды — read committed, repeatable read, serializable).  
- Durability: результат коммита сохраняется несмотря на сбои.  

Реализации:
- Блокировки (locks): простая модель, но может вести к contention.  
- MVCC (многоверсионная конкуренция): позволяет читателям не блокировать писателей, улучшая параллелизм.  
- WAL + checkpoints: для восстановления после краха.

---

### 6. Поддержание целостности
- Простейшие механизмы: PK, FK, UNIQUE, NOT NULL, CHECK.  
- Для бизнес‑правил: триггеры или хранимые процедуры (но это перемещает логику в БД — плюсы/минусы).  
- Нормализация — уменьшает дублирование; денормализация может применяться ради скорости чтения.  
- Всегда думай, кто — БД или приложение — отвечает за валидацию данных.

---

### 7. Высокая доступность и масштабирование
- Репликация: master → replicas для чтения; реплики используются для масштабирования чтений и резервирования.  
- Асинхронная репликация быстрее, но возможна небольшая рассинхронизация; синхронная — безопаснее, но медленнее записи.  
- Multi‑master: даёт записи на нескольких узлах, но требует решения конфликтов.  
- Шардирование: разбиваем таблицы по диапазону/хэшу ключа; увеличивает сложность топологии.  
- CAP: нельзя иметь одновременно всё при сетевых разрывах — выбираем компромисс (Consistency vs Availability).

---

### 8. Резервное копирование и восстановление
- Регулярные бэкапы: полные, инкрементные, дифференциальные.  
- PITR: Point‑In‑Time Recovery — восстановление до конкретного момента с помощью WAL.  
- Тестовое восстановление — обязательный элемент процедур DR.  

Постарайтесь автоматизировать бэкапы и проверку их целостности.

---

### 9. Мониторинг и эксплуатация
- Что мерить: latency (p50/p95/p99), throughput (TPS), IOPS, buffer hit ratio, lock waits, slow queries.  
- Инструменты: Prometheus + Grafana, pg_stat_statements (Postgres), Percona Monitoring, Datadog.  
- Логи: ошибки, медленные запросы, аудит доступа.  
- Автоматизация: миграции (Flyway/Liquibase), IaC (Terraform/Ansible), CI для миграций.

---

### 10. Расширения и интеграция
- Расширения БД (PostGIS, full‑text) добавляют новые типы данных и индексы.  
- CDC (Change Data Capture) позволяет стримить изменения в Kafka и т.д. — полезно для аналитики в реальном времени.  
- ETL/ELT: выстраиваем пайплайны для загрузки в DW / Data Lake.

---

### 11. Практические примеры "на пальцах"
- Быстрая агрегация по дате → индекс по date и партиционирование по году/месяцу.  
- История изменений → audit_log или использование WAL + инструментов.  
- Медиа-файлы → хранить в S3, в БД — метаданные и ссылки.

---

### 12. Ошибки, которых стоит избегать
- Индексация «всё подряд».  
- Отсутствие мониторинга и логов.  
- Не протестированные бэкапы.  
- Хранение больших BLOB в обычных таблицах без продуманной стратегии.

---

### 13. Одностраничная шпаргалка (Cheat Sheet)
- CRUD: INSERT / SELECT / UPDATE / DELETE  
- Инструменты анализа: EXPLAIN / EXPLAIN ANALYZE  
- Индексы: CREATE INDEX idx_name ON table(col); — не индексируй всё  
- Транзакция: BEGIN; ... COMMIT; или ROLLBACK  
- WAL: нужен для восстановления и Durability  
- MVCC: читатели не блокируют писателей (в Postgres)  
- Репликация: асинхронная — быстрый мастер; синхронная — более безопасна  
- Резервное копирование: полный + WAL архивация → PITR  
- Мониторинг: p99 latency, slow queries, buffer hit ratio

---

### 14. Примеры команд и шаблоны (PostgreSQL)
Ниже — практические примеры, которые можно сразу выполнять в pgAdmin/psql.

Создать таблицы:
```sql
CREATE TABLE customers (
  customer_id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT UNIQUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE TABLE orders (
  order_id SERIAL PRIMARY KEY,
  customer_id INT REFERENCES customers(customer_id),
  amount NUMERIC(10,2),
  order_date DATE DEFAULT CURRENT_DATE
);
```

Добавить индекс:
```sql
CREATE INDEX idx_orders_order_date ON orders (order_date);
```

Простой аналитический запрос и EXPLAIN:
```sql
EXPLAIN ANALYZE
SELECT c.name, COUNT(o.order_id) AS cnt, SUM(o.amount) AS total
FROM customers c
JOIN orders o ON c.customer_id = o.customer_id
WHERE o.order_date BETWEEN '2024-01-01' AND '2024-12-31'
GROUP BY c.name
ORDER BY total DESC;
```

Транзакция (оформление заказа):
```sql
BEGIN;
INSERT INTO orders (customer_id, amount) VALUES (1, 99.90) RETURNING order_id;
-- вставка позиций, уменьшение stock и другие действия
COMMIT;
```

Партиционирование (пример базовый):
```sql
CREATE TABLE orders_y2025 PARTITION OF orders FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');
```

Просмотр медленных запросов (пример для Postgres):
```sql
-- В postgresql.conf включить:
-- log_min_duration_statement = 2000  -- логирование запросов дольше 2000 ms
-- Затем смотреть log файлы или использовать pg_stat_statements
SELECT query, total_time, calls, mean_time
FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 20;
```

Резервное копирование (пример pg_basebackup):
```bash
pg_basebackup -D /var/lib/postgresql/backup -F tar -z -P -U replica_user --wal-method=fetch
```

---

#### Краткий конспект по SQL (DML/DDL/Транзакции)
- DDL: CREATE TABLE, ALTER TABLE, DROP TABLE — меняют схему.  
- DML: INSERT, SELECT, UPDATE, DELETE — работают с данными.  
- TCL: BEGIN/COMMIT/ROLLBACK — управление транзакциями.  
- DCL: GRANT / REVOKE — управление правами.  
- Полезно: использовать подготовленные выражения (prepared statements) для безопасности и повторного использования.

---

#### Управление транзакциями
Транзакция — несколько операций, которые должны выполниться вместе. Пример — перевод денег между счетами:

```sql
-- Начало транзакции
BEGIN TRANSACTION;

-- Снимаем деньги с первого счета
UPDATE accounts SET balance = balance - 100 WHERE id = 1;

-- Добавляем на второй счет
UPDATE accounts SET balance = balance + 100 WHERE id = 2;

-- Если все операции успешны - подтверждаем
COMMIT;

-- Если что-то пошло не так - отменяем всё
-- ROLLBACK;
```

Свойства транзакций (ACID):
- Атомарность — всё или ничего  
- Согласованность — данные всегда в правильном состоянии  
- Изолированность — параллельные транзакции не мешают друг другу  
- Долговечность — результаты сохраняются после сбоев

---

#### Безопасность и доступ
Создание пользователей и заданий прав:

```sql
-- Создаем пользователя (синтаксис для MySQL/или схожий)
CREATE USER 'teacher' IDENTIFIED BY 'password123';

-- Даем права только на чтение таблицы students
GRANT SELECT ON students TO teacher;

-- Даем все права администратору
GRANT ALL PRIVILEGES ON students TO admin;
```

---

#### Резервное копирование и восстановление
Важность: если сервер сломается, данные не должны пропасть.

Типы бэкапов:
- Полные (вся база)  
- Разностные (только изменения с последнего полного бэкапа)  
- Инкрементальные (только новые изменения)

---

### 18. Почему СУБД лучше хранения в файлах (короткая таблица мыслей)
- Одновременная работа: файлы → конфликты; СУБД → управление доступом.  
- Поиск данных: файлы → медленно; СУБД → быстро (индексы).  
- Целостность: файлы → нет контроля; СУБД → проверки ограничений.  
- Безопасность: файлы → сложно; СУБД → встроенные механизмы.

---

### 19. Популярные СУБД
**Бесплатные:**  
- MySQL  
- PostgreSQL  
- SQLite (для маленьких проектов)

**Платные / коммерческие:**  
- Oracle  
- Microsoft SQL Server

---

### 20. Простые примеры из жизни (структуры)
**Библиотека:**

```sql
-- Таблица книг
CREATE TABLE books (
    book_id INT PRIMARY KEY,
    title VARCHAR(200),
    author VARCHAR(100),
    available BOOLEAN -- доступна ли книга
);

-- Таблица читателей
CREATE TABLE readers (
    reader_id INT PRIMARY KEY,
    name VARCHAR(100),
    phone VARCHAR(15)
);
```

**Интернет-магазин:**

```sql
-- Товары
CREATE TABLE products (
    product_id INT PRIMARY KEY,
    name VARCHAR(100),
    price DECIMAL(10,2),
    quantity INT -- количество на складе
);

-- Заказы
CREATE TABLE orders (
    order_id INT PRIMARY KEY,
    customer_name VARCHAR(100),
    order_date DATE,
    total_amount DECIMAL(10,2)
);
```

---

### 21. Главные преимущества СУБД
- Надёжность — данные защищены от сбоев.  
- Скорость — быстрый поиск даже в больших объёмах данных.  
- Безопасность — контроль кто что может делать.  
- Целостность — данные всегда корректные.  
- Многопользовательность — много людей могут работать одновременно.

**Вывод:** СУБД — это мощный инструмент для работы с данными, который обеспечивает надёжность, безопасность и эффективность. Любая серьёзная система (банки, магазины, соцсети) использует базы данных для хранения информации.

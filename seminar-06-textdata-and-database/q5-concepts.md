# Концепции целостности и надежности в системах хранения данных.

## 1. Типы целостности данных

### Сущностная целостность (Entity Integrity)
- **Определение**: Гарантирует уникальность каждой записи в таблице
- **Механизмы реализации**:
  - Первичные ключи (Primary Keys)
  - Ограничения уникальности (UNIQUE constraints)
  - Автоинкрементные идентификаторы
- **Пример**: 
  ```sql
  CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,  -- сущностная целостность
    email VARCHAR(255) UNIQUE    -- дополнительная гарантия уникальности
  );
  ```

### Ссылочная целостность (Referential Integrity)
- **Определение**: Обеспечивает корректность связей между таблицами
- **Механизмы**:
  - Внешние ключи (Foreign Keys)
  - Каскадные операции (CASCADE, SET NULL, RESTRICT)
- **Важность**: Предотвращает "висячие ссылки" и orphaned records

```sql
CREATE TABLE orders (
  order_id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(user_id) ON DELETE CASCADE
);
```

### Семантическая целостность (Semantic Integrity)
- **Определение**: Обеспечивает корректность значений данных согласно бизнес-правилам
- **Механизмы**:
  - Проверочные ограничения (CHECK constraints)
  - Триггеры (Triggers)
  - Типы данных (Data Types)
  - Ограничения NOT NULL

```sql
CREATE TABLE products (
  price DECIMAL(10,2) CHECK (price > 0),
  category VARCHAR(50) CHECK (category IN ('electronics', 'books', 'clothing')),
  created_at TIMESTAMP NOT NULL
);
```

## 2. Уровни изоляции, аномалии и стратегии

### Уровни изоляции транзакций (SQL Standard)

| Уровень | "Грязное" чтение | Неповторяющееся чтение | Фантомное чтение |
|---------|-------------------|------------------------|------------------|
| Read Uncommitted | ❌ Разрешено | ❌ Разрешено | ❌ Разрешено |
| Read Committed | ✅ Запрещено | ❌ Разрешено | ❌ Разрешено |
| Repeatable Read | ✅ Запрещено | ✅ Запрещено | ❌ Разрешено |
| Serializable | ✅ Запрещено | ✅ Запрещено | ✅ Запрещено |

### Аномалии параллельного доступа

**"Грязное" чтение (Dirty Read)**
> Чтение данных из незавершенной транзакции, которая может быть откатана

**Неповторяющееся чтение (Non-repeatable Read)**
> Ситуация, когда повторное чтение тех же данных в рамках одной транзакции возвращает разные значения

**Фантомное чтение (Phantom Read)**
> Появление новых строк при повторном выполнении того же запроса

**Потерянное обновление (Lost Update)**
> Два процесса читают одни данные, затем оба обновляют их, и одно обновление теряется

### Стратегии управления параллелизмом

**Пессимистичная блокировка**
- Блокировки на уровне строк/таблиц
- Предотвращает конфликты, но снижает производительность
- Подход: "лучше предотвратить, чем лечить"

**Оптимистичная блокировка**
- Версионность данных (MVCC - Multi-Version Concurrency Control)
- Проверка конфликтов при коммите
- Высокая производительность при низкой конфликтности

```sql
-- Пример оптимистичной блокировки
UPDATE products 
SET stock = stock - 1, version = version + 1 
WHERE product_id = 123 AND version = 5;
```

## 3. CAP, согласованность и распределённые транзакции

### Теорема CAP (Brewer's Theorem)

> Любая распределенная система может гарантировать только два из трех свойств:
> - **C**onsistency (согласованность)
> - **A**vailability (доступность)  
> - **P**artition tolerance (устойчивость к разделению)

**Реализации на практике**:
- **CP системы**: Cassandra, HBase, MongoDB (в некоторых конфигурациях)
- **AP системы**: DynamoDB, CouchDB, Cassandra (другие настройки)
- **CA системы**: Традиционные RDBMS (PostgreSQL, MySQL в одном узле)

### Модели согласованности

**Строгая согласованность (Strong Consistency)**
- Все узлы видят одни и те же данные в один момент времени
- Пример: Google Spanner, банковские системы

**Согласованность в конечном счете (Eventual Consistency)**
- Данные со временем становятся согласованными на всех узлах
- Пример: DNS, системы кэширования

**Согласованность на чтение (Read-Your-Writes Consistency)**
- Пользователь всегда видит свои собственные обновления

### Распределённые транзакции

**Двухфазный коммит (2PC)**
```
Координатор → Участники: PREPARE
Участники → Координатор: READY/ABORT
Координатор → Участники: COMMIT/ROLLBACK
```

**Проблемы 2PC**:
- Блокировки ресурсов на длительное время
- Координатор - единая точка отказа
- Сложность восстановления после сбоев

**Альтернативы**:
- **SAGA паттерн**: Последовательность компенсируемых транзакций
- **TCC (Try-Confirm-Cancel)**: Трехфазный подход для микросервисов

## 4. RPO, RTO, резервирование и тестирование

### Ключевые метрики восстановления

**RPO (Recovery Point Objective)**
> Максимально допустимый объем данных, который можно потерять при аварии

**Примеры**:
- RPO = 0: Нулевая потеря данных (синхронная репликация)
- RPO = 15 мин: Возможна потеря данных за последние 15 минут
- RPO = 24 часа: Допустима потеря данных за последние сутки

**RTO (Recovery Time Objective)**
> Максимально допустимое время простоя системы после аварии

**Примеры**:
- RTO = 5 мин: Критичные системы (финансовые операции)
- RTO = 4 часа: Бизнес-критичные системы
- RTO = 24 часа: Некритичные системы

### Стратегии резервирования

**Репликация данных**:
- **Синхронная**: Гарантирует нулевую потерю данных (высокая задержка)
- **Асинхронная**: Лучшая производительность (возможна потеря данных)

**Геораспределение**:
- Активный-активный: Нагрузка распределена между центрами
- Активный-пассивный: Резервный центр включается при сбое

**Типы резервных копий**:
```mermaid
graph LR
A[Полная копия] --> B[Дифференциальная] --> C[Инкрементальная]
```

### Тестирование аварийного восстановления

**Регулярные тесты**:
- Восстановление из backup в изолированной среде
- Тестирование failover механизмов
- Проверка процедур документации

**Метрики успешности**:
- Время восстановления ≤ RTO
- Объем потерянных данных ≤ RPO
- Корректность работы приложения после восстановления

## 5. Соответствие требованиям и защита персональных данных

### Регуляторные требования

**GDPR (General Data Protection Regulation)**
- Право на удаление ("right to be forgotten")
- Согласие на обработку данных
- Уведомление о нарушениях в течение 72 часов

**HIPAA (Health Insurance Portability and Accountability Act)**
- Защита медицинской информации
- Аудит доступа к данным
- Шифрование передаваемых данных

**PCI DSS (Payment Card Industry Data Security Standard)**
- Защита данных платежных карт
- Регулярное тестирование систем безопасности
- Ограничение доступа по принципу "need-to-know"

### Принципы защиты данных

**Privacy by Design**
> Интеграция защиты приватности на этапе проектирования системы

**Data Minimization**
> Сбор только необходимых данных для конкретной цели

**Purpose Limitation** 
> Использование данных только для заявленных целей

### Технические меры защиты

**Шифрование**:
- **At-rest**: Шифрование данных на дисках (AES-256)
- **In-transit**: TLS для передачи данных
- **In-use**: Гомоморфное шифрование (обработка без расшифровки)

**Анонимизация и псевдонимизация**:
```sql
-- Псевдонимизация (обратимое)
UPDATE users SET email = CONCAT('user_', id, '@anonymous.com');

-- Анонимизация (необратимое)
UPDATE users SET 
  email = NULL,
  name = 'Anonymous',
  phone = NULL;
```

**Управление доступом**:
- RBAC (Role-Based Access Control)
- ABAC (Attribute-Based Access Control)
- Многофакторная аутентификация

### Процедуры соответствия

**DPIA (Data Protection Impact Assessment)**
> Оценка влияния на защиту данных перед запуском проекта

**Регистр обработки данных**
> Документирование всех процессов обработки персональных данных

**Назначение DPO (Data Protection Officer)**
> Ответственное лицо за соблюдение требований защиты данных

---

> **Ключевой вывод**: Целостность и надежность данных требуют комплексного подхода, сочетающего технические решения, процессы и соответствие регуляторным требованиям. Современные системы должны балансировать между производительностью, доступностью и безопасностью.
